import { useRuntime } from '@renderer/hooks/useRuntime'
import { useSettings } from '@renderer/hooks/useSettings'
import store from '@renderer/store'
import { Agent } from '@renderer/types'
import { useEffect, useState } from 'react'

let _agents: Agent[] = []

export const getAgentsFromSystemAgents = (systemAgents: any) => {
  const agents: Agent[] = []
  for (let i = 0; i < systemAgents.length; i++) {
    for (let j = 0; j < systemAgents[i].group.length; j++) {
      const agent = { ...systemAgents[i], group: systemAgents[i].group[j], topics: [], type: 'agent' } as Agent
      agents.push(agent)
    }
  }
  return agents
}

export function useSystemAgents() {
  const { defaultAgent } = useSettings()
  const [agents, setAgents] = useState<Agent[]>([])
  const { resourcesPath } = useRuntime()
  const { agentssubscribeUrl } = store.getState().settings

  useEffect(() => {
    const loadAgents = async () => {
      try {
        // 检查是否使用远程数据源
        if (agentssubscribeUrl && agentssubscribeUrl.startsWith('http')) {
          try {
            await new Promise((resolve) => setTimeout(resolve, 500))
            const response = await fetch(agentssubscribeUrl)
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`)
            }
            const agentsData = (await response.json()) as Agent[]
            setAgents(agentsData)
            return
          } catch (error) {
            console.error('Failed to load remote agents:', error)
            // 远程加载失败，继续尝试加载本地数据
          }
        }

        // 如果没有远程配置或获取失败，加载本地代理
        if (_agents.length === 0) {
          try {
            // 获取正确的文件路径（开发和生产环境兼容）
            const basePath = import.meta.env.DEV
              ? await window.api.path.join(process.cwd(), 'resources', 'data')
              : await window.api.app.getPath('resources')

            const agentsPath = await window.api.path.join(basePath, 'agents.json')

            console.log('Loading agents from:', agentsPath)

            try {
              const fileContent = await window.api.fs.read(agentsPath)
              _agents = JSON.parse(fileContent)?.agents || []
              console.log('Successfully loaded agents from:', agentsPath)
            } catch (err) {
              console.error('Failed to load agents file:', err)
              // 提供默认数据作为fallback
              _agents = [
                {
                  id: 'default-1',
                  name: '默认助手',
                  description: '系统默认提供的智能助手',
                  group: ['精选'],
                  icon: 'help-circle',
                  prompt: '你好！我是你的AI助手'
                }
              ]
            }
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`)
            }
            const data = await response.json()
            console.log('Loaded agents data:', data)
            _agents = data.agents || data // 兼容两种格式
            console.log('Parsed agents:', _agents)
          } catch (error) {
            console.error('Failed to load local agents:', error)
            _agents = [] // 确保有默认值
          }
        }

        console.log('Setting agents:', _agents)
        setAgents(_agents)
      } catch (error) {
        console.error('Failed to load agents:', error)
        // 发生错误时使用已加载的本地 agents
        setAgents(_agents)
      }
    }

    loadAgents()
  }, [defaultAgent, resourcesPath, agentssubscribeUrl])

  return agents
}

export function groupByCategories(data: Agent[]) {
  const groupedMap = new Map<string, Agent[]>()
  data.forEach((item) => {
    item.group?.forEach((category) => {
      if (!groupedMap.has(category)) {
        groupedMap.set(category, [])
      }
      groupedMap.get(category)?.push(item)
    })
  })
  const result: Record<string, Agent[]> = {}
  Array.from(groupedMap.entries()).forEach(([category, items]) => {
    result[category] = items
  })
  return result
}
